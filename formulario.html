<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Protótipo - Formulário</title>

    <link href="kendo/styles/default-main.css" rel="stylesheet" />
    <script src="kendo/js/jquery-4.0.0.min.js"></script>
    <script src="kendo/js/kendo.all.min.js"></script>
    <script src="license-kendo.js"></script>
    <script src="kendo/js/cultures/kendo.culture.pt-BR.min.js"></script>

    <style>
        html, body { height:100%; margin:0; }
        body { background:#f6f7fb; }

        :root{
            --header-h: 58px;
            --footer-h: 64px;
            --dt-w: 190px; /* reserva fixa pra data */
        }

        #page-root{
            height:100%;
            display:flex;
            flex-direction:column;
        }

        /* ============================================================
           APPBAR: FORÇAR O TEMPLATE A OCUPAR 100% DA LARGURA
           (esse é o pulo do gato do seu problema)
           ============================================================ */
        #topAppBar{
            position:sticky;
            top:0;
            z-index:10;
            box-shadow: 0 1px 0 rgba(0,0,0,.08);
        }

        /* o AppBar tem wrappers internos: garantimos largura total */
        #topAppBar .k-appbar,
        #topAppBar .k-appbar-content,
        #topAppBar .k-appbar-section,
        #topAppBar .k-appbar-items,
        #topAppBar .k-appbar-item,
        #topAppBar .k-appbar-item > span,
        #topAppBar .k-appbar-item > div {
            width: 100% !important;
            max-width: 100% !important;
            flex: 1 1 auto;
            box-sizing: border-box;
        }

        /* Linha única: título (corta) | data (fixa no canto direito) */
        .topbar-wrap{
            display:flex;
            align-items:center;
            justify-content:space-between;
            width:100%;
            min-height:40px;
            padding: 0 16px;
            box-sizing:border-box;
            gap: 14px;
        }

        .program-title{
            font-weight:800;
            font-size:16px;
            line-height:1.1;
            white-space:nowrap;
            overflow:hidden;
            text-overflow:ellipsis;

            flex: 1 1 auto;
            min-width: 0;
            padding-right: 14px;
            max-width: calc(100% - var(--dt-w));
        }

        .program-datetime{
            flex: 0 0 var(--dt-w);
            min-width: var(--dt-w);
            text-align:right;
            font-weight:700;
            font-size:13px;
            opacity:.85;
            white-space:nowrap;
        }

        /* Ações */
        #actionsBar{
            position:sticky;
            top: var(--header-h);
            z-index:9;
            background:#fff;
            border-bottom:1px solid rgba(0,0,0,.08);
        }

        /* Duas toolbars: desktop e mobile */
        #toolbarDesktop{ display:block; }
        #toolbarMobile{ display:none; }

        @media (max-width: 720px){
            #toolbarDesktop{ display:none; }
            #toolbarMobile{ display:block; }
            :root{
                --header-h: 56px;
                --dt-w: 150px;
            }
            .topbar-wrap{ padding: 0 12px; gap: 10px; }
            .program-title{ font-size:15px; max-width: calc(100% - var(--dt-w)); }
            .program-datetime{ font-size:12px; }
        }

        /* Conteúdo: ocupa tudo */
        .content{
            flex: 1;
            display:flex;
            padding: 14px;
            padding-bottom: calc(var(--footer-h) + 18px);
            width:100%;
            box-sizing:border-box;
        }

        .card{
            flex:1;
            display:flex;
            flex-direction:column;
            background:#fff;
            border:1px solid rgba(0,0,0,.08);
            border-radius: 14px;
            box-shadow: 0 6px 18px rgba(0,0,0,.05);
            padding: 14px;
            min-height: 100%;
            box-sizing:border-box;
        }

        .form-grid{
            display:grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            width:100%;
        }

        .field{
            display:flex;
            flex-direction:column;
            gap:6px;
        }

        .field label{
            font-size:12px;
            font-weight:700;
            opacity:.8;
        }

        @media (max-width: 720px){
            .content{ padding: 12px; padding-bottom: calc(var(--footer-h) + 16px); }
            .form-grid{ grid-template-columns: 1fr; }
        }

        /* Barra inferior fixa */
        #bottomBar{
            position:fixed;
            left:0;
            right:0;
            bottom:0;
            z-index:12;
            background:#fff;
            border-top:1px solid rgba(0,0,0,.10);
            padding: 10px 14px;
            box-sizing:border-box;
        }

        .bottom-wrap{
            width:100%;
            display:flex;
            gap:10px;
            justify-content:flex-start; /* esquerda */
            align-items:center;
        }

        @media (max-width: 720px){
            .bottom-wrap .k-button{ flex:1; }
        }
    </style>
</head>

<body>
<div id="page-root">

    <!-- AppBar (Topo) -->
    <div id="topAppBar"></div>

    <!-- Barra de ações -->
    <div id="actionsBar">
        <div id="toolbarDesktop"></div>
        <div id="toolbarMobile"></div>
    </div>

    <!-- Conteúdo -->
    <div class="content">
        <div class="card">
            <div class="form-grid">
                <div class="field">
                    <label>Código</label>
                    <input id="fldCodigo" />
                </div>

                <div class="field">
                    <label>Data</label>
                    <input id="fldData" />
                </div>

                <div class="field">
                    <label>Cliente</label>
                    <input id="fldCliente" />
                </div>

                <div class="field">
                    <label>Status</label>
                    <input id="fldStatus" />
                </div>

                <div class="field" style="grid-column: 1 / -1;">
                    <label>Observações</label>
                    <textarea id="fldObs"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Barra inferior -->
    <div id="bottomBar">
        <div class="bottom-wrap">
            <button id="btnConfirmar">Confirmar</button>
            <button id="btnCancelar">Cancelar</button>
        </div>
    </div>

</div>

<!-- Dialog Exclusão -->
<div id="dialogExcluir"></div>

<script>
    kendo.culture("pt-BR");

    // data/hora FIXA na entrada
    const enteredAt = new Date();

    let editMode = false;
    let favoritado = false;

    function pad2(n){ return String(n).padStart(2, "0"); }

    function enteredAtLabel(){
        const d = enteredAt;
        const dd = pad2(d.getDate());
        const mm = pad2(d.getMonth() + 1);
        const yyyy = d.getFullYear();
        const hh = pad2(d.getHours());
        const mi = pad2(d.getMinutes());
        const ss = pad2(d.getSeconds());
        return `${dd}/${mm}/${yyyy} ${hh}:${mi}:${ss}`;
    }

    function setEditMode(isEdit){
        editMode = !!isEdit;

        $("#fldCodigo").data("kendoTextBox").readonly(!editMode);
        $("#fldCliente").data("kendoTextBox").readonly(!editMode);
        $("#fldStatus").data("kendoTextBox").readonly(!editMode);
        $("#fldObs").data("kendoTextArea").readonly(!editMode);
        $("#fldData").data("kendoDatePicker").enable(editMode);

        $("#btnConfirmar").data("kendoButton").enable(editMode);
        $("#btnCancelar").data("kendoButton").enable(editMode);

        const tbD = $("#toolbarDesktop").data("kendoToolBar");
        const tbM = $("#toolbarMobile").data("kendoToolBar");

        [tbD, tbM].forEach(tb => {
            if(!tb) return;
            tb.enable("#actIncluir", !editMode);
            tb.enable("#actAlterar", !editMode);
            tb.enable("#actExcluir", !editMode);
        });
    }

    function onIncluir(){ setEditMode(true); }
    function onAlterar(){ setEditMode(true); }

    function onExcluir(){
        if(editMode) return;
        $("#dialogExcluir").data("kendoDialog").open();
    }

    function onConfirmar(){
        alert("Confirmado (protótipo).");
        setEditMode(false);
    }

    function onCancelar(){
        alert("Cancelado (protótipo).");
        setEditMode(false);
    }

    function syncFavSelected(){
        const tbD = $("#toolbarDesktop").data("kendoToolBar");
        const tbM = $("#toolbarMobile").data("kendoToolBar");
        [tbD, tbM].forEach(tb => {
            if(!tb) return;
            const $btn = tb.element.find("#actFav");
            $btn.attr("aria-pressed", favoritado ? "true" : "false");
            $btn.toggleClass("k-selected", !!favoritado);
            $btn.attr("title", favoritado ? "Remover dos favoritos" : "Adicionar aos favoritos");
        });
    }

    function onToggleFav(e){
        const btn = $(e.target).closest(".k-toolbar-button, .k-button, button");
        favoritado = (btn.attr("aria-pressed") === "true");
        syncFavSelected();
    }

    function buildToolbar($el, isMobile){
        $el.kendoToolBar({
            resizable: isMobile,                 // agrupa só no mobile
            overflowMode: isMobile ? "popup" : "none",
            items: [
                { type:"button", id:"actIncluir", text:"Incluir", icon:"plus", click:onIncluir, overflow:"never" },
                { type:"button", id:"actAlterar", text:"Alterar", icon:"pencil", click:onAlterar, overflow:"never" },
                { type:"button", id:"actExcluir", text:"Excluir", icon:"trash", click:onExcluir, overflow:"never" },

                { type:"separator" },

                { type:"button", id:"actLogs", text:"Logs", icon:"info-circle", click:()=>alert("Abrir Logs (protótipo)"), overflow: isMobile ? "auto" : "never" },
                { type:"button", id:"actManual", text:"Manual", icon:"file-txt", click:()=>alert("Abrir Manual (protótipo)"), overflow: isMobile ? "auto" : "never" },
                { type:"button", id:"actBug", text:"Reportar Problema", icon:"warning-triangle", click:()=>alert("Reportar Problema (protótipo)"), overflow: isMobile ? "auto" : "never" },

                { type:"separator" },

                {
                    type:"toggleButton",
                    id:"actFav",
                    text:"",
                    icon:"star-outline",
                    togglable:true,
                    selected:false,
                    click:onToggleFav,
                    overflow:"never"
                }
            ]
        });
    }

    $(function(){

        // AppBar: agora o template ocupa 100% da largura real do AppBar
        $("#topAppBar").kendoAppBar({
            themeColor: "light",
            items: [{
                template: `
          <div class="topbar-wrap">
            <div class="program-title" title="Cadastro de Exemplo">Cadastro de Exemplo</div>
            <div class="program-datetime" title="Data/Hora de entrada">${enteredAtLabel()}</div>
          </div>
        `
            }]
        });

        buildToolbar($("#toolbarDesktop"), false);
        buildToolbar($("#toolbarMobile"), true);

        $("#fldCodigo").kendoTextBox({ value: "000123" });
        $("#fldCliente").kendoTextBox({ value: "Cliente Exemplo LTDA" });
        $("#fldStatus").kendoTextBox({ value: "Ativo" });
        $("#fldData").kendoDatePicker({ value: new Date(), format: "dd/MM/yyyy" });
        $("#fldObs").kendoTextArea({
            value: "Somente leitura no início. Clique em Incluir ou Alterar para editar.",
            rows: 6
        });

        $("#btnConfirmar").kendoButton({ themeColor:"primary", enable:false, click:onConfirmar });
        $("#btnCancelar").kendoButton({ themeColor:"base", enable:false, click:onCancelar });

        $("#dialogExcluir").kendoDialog({
            width: "420px",
            title: "Confirmação de Exclusão",
            visible: false,
            modal: true,
            content: "<p>Tem certeza que deseja excluir este registro?</p>",
            actions: [
                { text: "Cancelar" },
                {
                    text: "Confirmar Exclusão",
                    primary: true,
                    themeColor: "error",
                    action: function(){
                        alert("Registro excluído (protótipo).");
                    }
                }
            ]
        });

        setEditMode(false);
        syncFavSelected();
    });
</script>
</body>
</html>
