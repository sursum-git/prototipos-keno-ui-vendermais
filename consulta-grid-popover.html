<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Grid - Desktop compacto (preço resumo + popover) + Stack Mobile</title>

    <link href="kendo/styles/default-main.css" rel="stylesheet" />
    <script src="kendo/js/jquery-3.7.1.min.js"></script>
    <script src="kendo/js/kendo.all.min.js"></script>
    <script src="license-kendo.js"></script>
    <script src="kendo/js/cultures/kendo.culture.pt-BR.min.js"></script>

    <style>
        html, body { height:100%; margin:0; }
        body { padding:14px; background:#f6f7fb; }
        #grid { width:100%; }

        /* toolbar */
        .bulkbar{
            display:flex; gap:8px; align-items:center; flex-wrap:wrap;
            padding:6px 0;
        }
        .bulkbar .spacer { flex:1 1 auto; }
        .bulkbar .bulkcount { font-size:12px; opacity:.7; }

        .bulk-actions-desktop{ display:flex; gap:8px; flex-wrap:wrap; }
        .bulk-actions-mobile{ display:none; }
        .is-stacked .bulk-actions-desktop{ display:none; }
        .is-stacked .bulk-actions-mobile{ display:inline-flex; }

        /* ---- Card (stack) ---- */
        .is-stacked .k-grid-content tr td{ padding:10px !important; background:transparent; border:0; }
        .is-stacked .k-grid-content tr{ background:transparent; }

        .stack-card{
            border-radius: 16px;
            background: #fff;
            border: 1px solid rgba(0,0,0,.06);
            box-shadow: 0 8px 20px rgba(0,0,0,.06);
            overflow: hidden;
        }
        .stack-head{
            padding: 12px 12px 10px;
            display:flex;
            gap:12px;
            align-items:flex-start;
            justify-content:space-between;
            border-bottom: 1px solid rgba(0,0,0,.06);
        }
        .stack-title{ font-weight: 900; font-size: 14px; line-height: 1.1; }
        .stack-sub{ margin-top: 4px; font-size: 12px; line-height: 1.25; opacity: .8; }
        .stack-chips{
            margin-top: 10px; display:flex; flex-wrap:wrap; gap:6px; font-size: 12px;
        }
        .chip{
            display:inline-flex; align-items:center; gap:6px; padding: 4px 10px;
            border-radius: 999px; background: rgba(0,0,0,.03);
            border: 1px solid rgba(0,0,0,.08); white-space: nowrap;
        }
        .chip b{ font-weight: 900; }
        .stack-body{ padding: 10px 12px 12px; }

        /* botão ⋮ */
        .row-actions-btn.k-button { min-width: 36px; padding: 0 8px; }
        .row-actions-glyph { font-size: 18px; line-height:1; display:inline-block; transform: translateY(-1px); }

        /* TabStrip (stack) */
        .stack-tabs > ul{ list-style:none; margin:0; padding:0; }
        .stack-tabs .k-tabstrip-items { border-bottom: 1px solid rgba(0,0,0,.06); padding: 0 6px; }
        .stack-tabs .k-item.k-state-default {
            border-radius: 999px; margin: 6px 6px 8px;
            border: 1px solid rgba(0,0,0,.08); background: rgba(0,0,0,.02);
        }
        .stack-tabs .k-item.k-state-active{ background: rgba(0,0,0,.06); }
        .stack-tabs .k-link{ padding: 8px 12px !important; font-weight: 800; font-size: 12px; }

        .price-grid{ display:grid; grid-template-columns: 1fr; gap: 6px; font-size: 12px; margin-top: 6px; }
        .price-row{
            display:flex; justify-content:space-between; gap: 10px;
            padding: 8px 10px; border-radius: 12px;
            background: rgba(0,0,0,.02); border: 1px solid rgba(0,0,0,.06);
        }
        .price-row b{ font-weight: 900; }
        .stack-interactive { touch-action: manipulation; }

        /* --- Desktop: coluna preço resumo + botão detalhes --- */
        .price-mini{
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:8px;
            white-space:nowrap;
        }
        .price-mini .big{ font-weight:900; }
        .price-details-btn.k-button{
            padding: 2px 8px;
            min-width: auto;
        }

        /* Popover tabela */
        .price-popover{
            font-size: 12px;
            width: 320px;
        }
        .price-popover table{
            width:100%;
            border-collapse:collapse;
        }
        .price-popover td{
            padding:6px 6px;
            border-bottom:1px solid rgba(0,0,0,.08);
        }
        .price-popover tr:last-child td{ border-bottom:0; }
        .price-popover td:last-child{
            text-align:right;
            font-weight:900;
            white-space:nowrap;
        }
        .price-popover .sec{
            margin:8px 0 4px;
            font-weight:900;
            opacity:.85;
        }
    </style>
</head>

<body>
<div id="grid"></div>

<script>
    kendo.culture("pt-BR");

    const data = [
        { id: 1, codProd: "P-0001", descProd: "Produto A - Tecido Algodão 1,60m", un: "MT",
            prontaQt: 120, programadoQt: 300, primeiraChegada: new Date(2026, 1, 25),
            pe_padrao: 19.90, pe_promocao: 17.90, pe_rubi: 18.90, pe_safira: 18.50,
            pi_padrao: 20.50, pi_rubi: 19.70
        },
        { id: 2, codProd: "P-0014", descProd: "Produto B - Malha Poliéster 180g", un: "KG",
            prontaQt: 0, programadoQt: 850, primeiraChegada: new Date(2026, 2, 3),
            pe_padrao: 12.40, pe_promocao: 11.10, pe_rubi: 11.80, pe_safira: 11.60,
            pi_padrao: 12.90, pi_rubi: 12.10
        },
        { id: 3, codProd: "P-0022", descProd: "Produto C - Fio 30/1 Penteado", un: "CX",
            prontaQt: 44, programadoQt: 120, primeiraChegada: new Date(2026, 1, 19),
            pe_padrao: 89.00, pe_promocao: 82.00, pe_rubi: 85.00, pe_safira: 84.00,
            pi_padrao: 90.00, pi_rubi: 86.50
        }
    ];

    // --------- AÇÕES (⋮ e lote) ----------
    const ACTIONS = {
        book_pi:   "Gerar Book PI",
        book_pe:   "Gerar Book PE",
        est_pi:    "Consultar Estoque PI",
        est_pe:    "Consultar Estoque PE",
        est_ambos: "Consultar PE + PI"
    };

    const ACTION_ITEMS = [
        { id:"book_pi", text:ACTIONS.book_pi },
        { id:"book_pe", text:ACTIONS.book_pe },
        { separator:true },
        { id:"est_pi", text:ACTIONS.est_pi },
        { id:"est_pe", text:ACTIONS.est_pe },
        { id:"est_ambos", text:ACTIONS.est_ambos }
    ];

    function getSelectedItems(g){
        const items=[];
        g.select().each(function(){
            const di = g.dataItem(this);
            if (di) items.push(di.toJSON ? di.toJSON() : di);
        });
        return items;
    }

    // stubs
    function runActionSingle(action, item){
        kendo.alert("<b>"+kendo.htmlEncode(ACTIONS[action]||action)+"</b><br><br>"
            + kendo.htmlEncode(item.codProd) + " - " + kendo.htmlEncode(item.descProd));
    }
    function runActionBulk(action, items){
        if(!items.length) return kendo.alert("Selecione pelo menos uma linha.");
        const lista = items.map(x => `${kendo.htmlEncode(x.codProd)} - ${kendo.htmlEncode(x.descProd)}`).join("<br>");
        kendo.alert("<b>"+kendo.htmlEncode(ACTIONS[action]||action)+"</b><br><br>"+lista);
    }

    // --------- PREÇO: helpers seguros ----------
    function isNum(v){ return typeof v === "number" && !isNaN(v); }
    function fmtC2(v){ return isNum(v) ? kendo.toString(v, "c2") : "-"; }

    function maxPrice(item){
        const vals = [
            item.pe_padrao, item.pe_promocao, item.pe_rubi, item.pe_safira,
            item.pi_padrao, item.pi_rubi
        ].filter(isNum);
        if (!vals.length) return null;
        return Math.max.apply(null, vals);
    }

    function pricePopoverHtml(item){
        const pe = [
            ["Padrão", item.pe_padrao],
            ["Promoção", item.pe_promocao],
            ["Rubi", item.pe_rubi],
            ["Safira", item.pe_safira]
        ];
        const pi = [
            ["Padrão", item.pi_padrao],
            ["Rubi", item.pi_rubi]
        ];

        const row = (label, val) =>
            `<tr><td>${kendo.htmlEncode(label)}</td><td>${fmtC2(val)}</td></tr>`;

        return `
      <div class="price-popover">
        <div style="font-weight:900; margin-bottom:6px;">
          ${kendo.htmlEncode(item.codProd)} — ${kendo.htmlEncode(item.descProd)}
        </div>

        <div class="sec">PE</div>
        <table>${pe.map(x => row(x[0], x[1])).join("")}</table>

        <div class="sec">PI</div>
        <table>${pi.map(x => row(x[0], x[1])).join("")}</table>
      </div>
    `;
    }

    // --------- COLUNAS DESKTOP ----------
    const columnsColumnsMode = [
        {
            title:"",
            width: 64,
            sortable:false,
            filterable:false,
            headerAttributes:{ style:"text-align:center" },
            attributes:{ style:"text-align:center" },
            template: `
        <button type="button" class="row-actions-btn row-actions-ddb" data-uid="#= uid #" title="Ações">
          <span class="row-actions-glyph">⋮</span>
        </button>
      `
        },
        {
            field:"codProd", title:"Código", width:140,
            filterable:{ extra:false, operators:{ string:{ contains:"Contém", eq:"Igual" } } }
        },
        {
            field:"descProd", title:"Descrição", width:360,
            filterable:{ extra:false, operators:{ string:{ contains:"Contém", eq:"Igual" } } }
        },
        { field:"un", title:"Un.", width:90, filterable:false },
        { field:"prontaQt", title:"Pronta", width:110, format:"{0:n0}", filterable:false },
        { field:"programadoQt", title:"Prog.", width:110, format:"{0:n0}", filterable:false },
        { field:"primeiraChegada", title:"1ª Chegada", width:140, format:"{0:dd/MM/yyyy}", filterable:false },

        {
            title:"Maior preço",
            width: 240,
            sortable: false,
            filterable: false,
            template: function(d){
                const m = maxPrice(d);
                const txt = (m == null) ? "-" : fmtC2(m);
                return `
          <div class="price-mini">
            <span class="big">${txt}</span>
            <button type="button"
              title="Ver tabela de preços"
              class="k-button k-button-sm k-rounded-md k-button-solid k-button-solid-base price-details-btn"
              data-uid="${d.uid}">Detalhes</button>
          </div>
        `;
            }
        }
    ];

    // --------- STACK ----------
    const columnsStackedCard = [ { sortable:false, filterable:false, title:"" } ];

    const stackedRowTemplate = kendo.template(`
    <tr data-uid="#= uid #">
      <td>
        <div class="stack-card">
          <div class="stack-head">
            <div style="min-width:0;">
              <div class="stack-title">#= kendo.htmlEncode(codProd) #</div>
              <div class="stack-sub">#= kendo.htmlEncode(descProd) #</div>
              <div class="stack-chips">
                <span class="chip">Un: <b>#= kendo.htmlEncode(un) #</b></span>
                <span class="chip">Pronta: <b>#= kendo.toString(prontaQt,"n0") #</b></span>
                <span class="chip">Prog: <b>#= kendo.toString(programadoQt,"n0") #</b></span>
                <span class="chip">1ª Chegada: <b>#= kendo.toString(primeiraChegada,"dd/MM/yyyy") #</b></span>
              </div>
            </div>
            <div class="stack-interactive">
              <button type="button" class="row-actions-btn row-actions-ddb" data-uid="#= uid #" title="Ações">
                <span class="row-actions-glyph">⋮</span>
              </button>
            </div>
          </div>

          <div class="stack-body">
            <div class="stack-tabs stack-interactive" id="tabs_#= uid #">
              <ul>
                <li class="k-state-active">PE</li>
                <li>PI</li>
              </ul>

              <div>
                <div class="price-grid">
                  <div class="price-row"><span>Padrão</span><b>#= (pe_padrao != null ? kendo.toString(pe_padrao,"c2") : "-") #</b></div>
                  <div class="price-row"><span>Promoção</span><b>#= (pe_promocao != null ? kendo.toString(pe_promocao,"c2") : "-") #</b></div>
                  <div class="price-row"><span>Rubi</span><b>#= (pe_rubi != null ? kendo.toString(pe_rubi,"c2") : "-") #</b></div>
                  <div class="price-row"><span>Safira</span><b>#= (pe_safira != null ? kendo.toString(pe_safira,"c2") : "-") #</b></div>
                </div>
              </div>

              <div>
                <div class="price-grid">
                  <div class="price-row"><span>Padrão</span><b>#= (pi_padrao != null ? kendo.toString(pi_padrao,"c2") : "-") #</b></div>
                  <div class="price-row"><span>Rubi</span><b>#= (pi_rubi != null ? kendo.toString(pi_rubi,"c2") : "-") #</b></div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </td>
    </tr>
  `);

    // --------- SWITCH AUTO/COLUMNS/STACK ----------
    let mode = "auto";
    let currentLayout = null;
    const BREAKPOINT = 900;
    let applying = false;

    function wantStacked(){
        if (mode === "stacked") return true;
        if (mode === "columns") return false;
        return $("#grid").width() < BREAKPOINT;
    }

    function applyLayoutIfChanged(){
        const g = $("#grid").data("kendoGrid");
        if (!g || applying) return;

        const next = wantStacked() ? "stacked" : "columns";
        if (currentLayout === next) return;
        currentLayout = next;

        applying = true;
        requestAnimationFrame(() => {
            try{
                if (next === "stacked"){
                    g.setOptions({
                        columns: columnsStackedCard,
                        rowTemplate: stackedRowTemplate,
                        altRowTemplate: stackedRowTemplate,
                        scrollable: true
                    });
                    g.wrapper && g.wrapper.addClass("is-stacked");
                } else {
                    g.setOptions({
                        columns: columnsColumnsMode,
                        rowTemplate: null,
                        altRowTemplate: null,
                        scrollable: true
                    });
                    g.wrapper && g.wrapper.removeClass("is-stacked");
                }
                requestAnimationFrame(() => g.resize());
            } finally {
                applying = false;
            }
        });
    }

    // --------- GRID ----------
    const grid = $("#grid").kendoGrid({
        dataSource: { data, pageSize: 10, schema: { model: { id:"id" } } },
        height: 540,
        pageable: true,
        sortable: true,
        filterable: true,
        resizable: true,
        selectable: "multiple, row",
        scrollable: true,
        columns: columnsColumnsMode,

        toolbar: [
            "search",
            {
                template: `
          <div class="bulkbar">
            <div class="bulk-actions-desktop">
              <button class="bulk-action-btn" data-action="book_pi">${ACTIONS.book_pi}</button>
              <button class="bulk-action-btn" data-action="book_pe">${ACTIONS.book_pe}</button>
              <button class="bulk-action-btn" data-action="est_pi">${ACTIONS.est_pi}</button>
              <button class="bulk-action-btn" data-action="est_pe">${ACTIONS.est_pe}</button>
              <button class="bulk-action-btn" data-action="est_ambos">${ACTIONS.est_ambos}</button>
            </div>

            <div class="bulk-actions-mobile">
              <button id="bulkActionsMobile">Ações</button>
            </div>

            <span class="bulkcount" id="bulkCount">nenhum selecionado</span>
            <span class="spacer"></span>

            <button id="btnAuto">Auto</button>
            <button id="btnColumns">Columns</button>
            <button id="btnStacked">Stack</button>
          </div>
        `
            }
        ],

        change: function(){ updateBulkUI(this); },

        dataBound: function(){
            const g = this;
            if (!g.wrapper) return;
            const $wrap = g.wrapper;

            if (currentLayout === "stacked") $wrap.addClass("is-stacked");
            else $wrap.removeClass("is-stacked");

            // destruir widgets nossos
            $wrap.find(".row-actions-ddb").each(function(){
                const w = $(this).data("kendoDropDownButton");
                if (w) w.destroy();
            });

            const bulkW = $("#bulkActionsMobile").data("kendoDropDownButton");
            if (bulkW) bulkW.destroy();

            $wrap.find(".stack-tabs").each(function(){
                const t = $(this).data("kendoTabStrip");
                if (t) t.destroy();
            });

            const pop = $wrap.data("kendoPopover");
            if (pop) pop.destroy();

            // topo: botões
            $(".bulk-action-btn").each(function(){
                if (!$(this).data("kendoButton")) $(this).kendoButton({ themeColor:"base" });
            });
            if (!$("#btnAuto").data("kendoButton")) $("#btnAuto").kendoButton({ themeColor:"base" });
            if (!$("#btnColumns").data("kendoButton")) $("#btnColumns").kendoButton({ themeColor:"base" });
            if (!$("#btnStacked").data("kendoButton")) $("#btnStacked").kendoButton({ themeColor:"base" });

            $("#bulkActionsMobile").kendoDropDownButton({
                items: ACTION_ITEMS,
                themeColor: "base",
                click: function(e){ runActionBulk(e.id, getSelectedItems(g)); }
            });

            // ⋮ por linha
            $wrap.find(".row-actions-ddb").each(function(){
                const $btn = $(this);
                const uid = $btn.data("uid");

                $btn.kendoDropDownButton({
                    items: ACTION_ITEMS,
                    fillMode: "flat",
                    rounded: "md",
                    size: "small",
                    themeColor: "base",
                    icon: null,
                    click: function(e){
                        const item = g.dataSource.getByUid(uid);
                        if (item) runActionSingle(e.id, item.toJSON ? item.toJSON() : item);
                    }
                });
            });

            // Stack: tabs
            if (currentLayout === "stacked") {
                $wrap.find(".stack-tabs").each(function(){
                    const tab = $(this).kendoTabStrip({ animation: { open: { effects: "fadeIn" } } }).data("kendoTabStrip");
                    if (tab) tab.select(0);
                });

                $wrap.off("click.stackStop").on("click.stackStop", ".stack-interactive *", function(ev){
                    ev.stopPropagation();
                });
            } else {
                $wrap.off("click.stackStop");
            }

            // Desktop: Popover de preços (AGORA CERTO)
            $wrap.kendoPopover({
                filter: ".price-details-btn",
                showOn: "click",
                position: "left",
                width: 340,
                header: "Preços (PE/PI)",
                encoded: false, // <<< ESSENCIAL: renderiza HTML (tabela) de verdade
                content: function(e){
                    const $btn = $(e.target).closest(".price-details-btn");
                    const uid = $btn.data("uid");
                    const item = uid ? g.dataSource.getByUid(uid) : null;

                    if (!item) return "<div style='padding:8px;'>Item não encontrado.</div>";

                    const obj = item.toJSON ? item.toJSON() : item;
                    return pricePopoverHtml(obj);
                }
            });

            // Evita que clicar no botão “Detalhes” altere seleção da linha
            $wrap.off("click.stopSelectPrice").on("click.stopSelectPrice", ".price-details-btn", function(ev){
                ev.stopPropagation();
            });

            updateBulkUI(g);

            if (!g._wired){
                g._wired = true;

                $wrap.on("click", ".bulk-action-btn", function(ev){
                    ev.preventDefault();
                    runActionBulk($(this).data("action"), getSelectedItems(g));
                });

                $("#btnAuto").on("click", () => { mode="auto"; currentLayout=null; applyLayoutIfChanged(); });
                $("#btnColumns").on("click", () => { mode="columns"; currentLayout=null; applyLayoutIfChanged(); });
                $("#btnStacked").on("click", () => { mode="stacked"; currentLayout=null; applyLayoutIfChanged(); });

                $(window).on("resize.gridLayout", kendo.throttle(applyLayoutIfChanged, 200));
            }
        }
    }).data("kendoGrid");

    function updateBulkUI(g){
        const count = g.select().length;
        $("#bulkCount").text(count ? (count + " selecionado(s)") : "nenhum selecionado");

        $(".bulk-action-btn").each(function(){
            const btn = $(this).data("kendoButton");
            if (btn) btn.enable(count > 0);
        });

        const ddb = $("#bulkActionsMobile").data("kendoDropDownButton");
        if (ddb) ddb.enable(count > 0);
    }

    // init
    applyLayoutIfChanged();
</script>
</body>
</html>
